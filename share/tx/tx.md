## 트랜잭션

- 데이터 시스템에서 문제가 발생할 수 있는 경우
    - 데이터베이스 소프트웨어나 하드웨어는(쓰기 연산이 실행 중일 때를 포함해서) 언제라도 실패할 수 있다
    - 애플리케이션은 (연속된 연산이 실행되는 도중도 포함해서) 언제라도 죽을 수 있다
    - 네트워크가 끊길 수 있다
        - 애플리케이션과 데이터베이스 사이
        - 데이터베이스 노드들 사이
    - 여러 클라이언트가 동시에 데이터베이스에 쓰기
        - 다른 클라이언트의 내용 변경

어떻게 하면 이런 상황 가운데서도 믿을 수 있는 데이터 시스템을 만들 수 있을까요?

### 트랜잭션이란?
앞선 문제들을 단순화 하는 메커니즘
- 몇 개의 읽기와 쓰기를 하나의 __논리적__ 단위로 묶는 방법
    - 개념적으로 묶인 연산들을 하나로 취급
    - 성공(커밋)하거나 실패(롤백)하거나 둘 중 하나
- 오류처리가 단순해짐
    - 애매하게 중간인 상태가 없기 때문 (그것을 가정해주는 개념)

`즉 중간인 경우가 없기에, 트랜잭션을 사용하면 성공 혹은 실패인 경우만 고려하면 됨 -> 가정을 통한 문제의 단순화(복잡해 질 수 있는 '이도저도 아닌 경우'를 트랜잭션에게 맡김)`

### ACID의 의미
> 현실에서는 데이터베이스마다 ACID 구현이 제각각....

각각의 정의를 파헤쳐봅시다

#### Atomicity (원자성)
> 'ACID의 맥락에서 보면 원자성은 동시성과 관련이 없다' (동시성은 격리성에서 다룬다)

원자적 == 쪼갤 수 없는 무언가

무슨일이 생겨도 (위에 있던 여러가지 장애들이 발생해도) 트랜잭션의 일부만 적용되는 일이 없음을 보장
- 모든 연산이 적용되거나
- 모든 연산이 안 적용됨

#### Consistency (일관성)
> 일관성을 유지하도록 트랜잭션을 올바르게 정의하는 것은 애플리케이션의 책임이다.

일관성 == 항상 진실이어야 하는, 데이터에 관한 어떤 선언이 존재(불변식, invariant)
- 예를 들어 송금의 경우
    - 보낸사람 금액 == 받은사람 금액

실제로 데이터베이스에서 강제할 수 있는 부분이 아님..!!
- 데이터베이스는 애플리케이션에서 시키는 대로 쓰기를 할 뿐
    - 일관성이 애플리케이션의 책임인 이유!

#### Isolation (격리성)
> 대부분 동시에 여러 클라이언트에서 데이터베이스에 접속한다.

직렬성 == 트랜잭션은 다른 트랜잭션을 방해할 수 없다 (동시에 존재하는 트랜잭션 때문에 내 트랜잭션이 영향을 받으면 안됨)
- 가장 높은 격리수준
- 각 트랜잭션이 전체 데이터베이스에서 실행되는 유일한 트랜잭션 인 것 처럼 동작
    - 즉 다른 트랜잭션 때문에 해당 트랜잭션이 영향을 받지 않음

`그러나 직렬성을 적용하면 성능상의 문제가 있기에 완화한 격리 속성을 둔다`
- 빠를 수 있도록 허락
    - 그러나 문제 생길 여지가 많아짐
    - 트레이드 오프 (각 속성이 어느정도 까지 보장해주는지를 확인해야 함)

#### Durability (지속성)

지속성 == 트랜잭션이 커밋되면 기록된 데이터는 손실되지 않음 (하드웨어 결함이 있건 데이터베이스가 죽건)

단일 노드 데이터베이스 에서 지속성
- 데이터가 비휘발성 장치에 기록됨 (즉 커밋 전에 데이터가 메모리에서 비휘발성 장치로 내려가야 함을 의미)
    - 그렇기에 데이터베이스가 죽어도 비휘발성 장치에 남아있음
        - 복구를 하든
        - 재시작때 읽어오든
    - 메모리에 캐시된 데이터가 내려가야함을 의미
        - 그래야 컴터가 꺼져서 메모리에 있는 데이터가 날라가도 문제가 없으니
    - 좀더 이해하기 쉬운 예시
        - 워드에서 저장하기를 누른 경우에 사용자가 원하는 것
            - 컴터를 껐다가 켜도 __저장한__ 문서를 사용가능
            - 즉, 저장한 이후에 컴터, 혹은 워드프로세서가 무슨일이 생겨서 꺼져도 해당 문서는 저장할 당시 그대로일꺼라고 생각함
            - 결과적으로 원하는 것을 이루기위한 방법으로 비휘발성 장치에 넣는 것일 뿐
- 보통 디스크에 저장된 데이터 구조가 오염됐을 때 복구할 수 있게 해주는, WAL등을 동반
    - 해당 디스크를 못써도 로그를 통해서 데이터들을 복구해낼수 있기에

복제 기능이 있는 데이터베이스
- 데이터가 성공적으로 다른 노드 몇개에 복사가 됨


### 출처
- 데이터 중심 어플리케이션 설계 - 마틴 클레프만